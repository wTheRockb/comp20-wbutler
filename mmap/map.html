<!DOCTYPE html>

<html>
<head>
<title> The Marauder's Maaeeepp </title>

<meta charset="utf-8">
<link rel="stylesheet" href="style.css" type="text/css" />
<script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=true">
      </script>

<script>
var myLat;
var myLng;
var myLoc = new google.maps.LatLng(myLat, myLng);
var infowindow = new google.maps.InfoWindow();
var request =  new XMLHttpRequest();
var mapOptions = {
          center: { lat: cred.latitude, lng: cred.longitude},
          zoom: 16
};
var response;
var map;
var markerArray = [];
var markerCArray = [];

function initialize () {
	 map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
	 getmylocation();
}

function getmylocation(){
 if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                        myLat = position.coords.latitude;
                        myLng = position.coords.longitude;
                        drawMap();
                });
        }
        else {
                alert("Geolocation is not supported by your web browser.  Upgrade required");
        }
}
function drawMap() //fills map, marks self with infowindow
{
        
        me = new google.maps.LatLng(myLat, myLng);        
        var userIcon = {
                url: 'ele.jpeg',
        };
        var userMarker = new google.maps.Marker({
                position: me,
                title: "User",
                icon: userIcon.url
        });
        userMarker.setMap(map);

        var myContent = '<b>' + userMarker.title + '<br></b>' +
                        '<p><b> Lat: </b>' + myLat + '<br>' +
                        '<b>Lng: </b>' + myLng + '</p>';
        var myWindow = new google.maps.InfoWindow({
                content: myContent
        });
        google.maps.event.addListener(myMarker, 'click', function() {
                myWindow.open(map, myMarker);
        });
        getStudents();
}

function getStudents() { //mingles with api, 
        var xhr = new XMLHttpRequest();
        http.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                        var studentList = JSON.parse(xhr.responseText);
                        loopMarkers(studentList);
                        loopDrawChars(studentList);
                }
        }
        //var url = "http://chickenofthesea.herokuapp.com/sendLocation";
        var params = "login=" + "SnowWhite" + "&lat="+ String(myLat) + "&lng=" + String(myLng);
        xhr.open("POST", "http://chickenofthesea.herokuapp.com/sendLocation", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.send(params);
        
}

function loopMarkers(studentList) { //places fucntion call to make markers for each char and stud, with imges for chars
        var numChars = studentList.characters.length;
        var numStuds = studentList.students.length;
   
        for (var i = 0; i < numChars; i++) {
                image = url: String(studentList.characters[i].name) + '.jpg';
                makeMarker(studentList.characters[i].loc.latitude, 
                           studentList.characters[i].loc.longitude, 
                           studentList.characters[i].name,
                           image);
        }
      
        for (var j = 0; j < numStuds; j++) {
                makeStudentMarker(studentList.students[j].lat,
                           studentList.students[j].lng,
                           studentList.students[j].login,
                           studentList.students[j].created_at);
        }
}

function makeMarker(lat, lng, title, image) //creates marker and window for entered char
{
        
        var cCoords = new google.maps.LatLng(lat, lng);
        var cMarker;

        renderLine(cCoords);
        cMarker = new google.maps.Marker({
                position: cCoords,
                title: title,
                icon: image.url
        });
        cMarker.setMap(map);
                
        var cContent = '<h1>' + title + '<br></h1>' +
                        '<p><b> Lat: </b>' + lat + '<br>' +
                        '<b>Lng: </b>' + lng + '</p>';
        var cWindow = new google.maps.InfoWindow({
                content: cContent
        });
        google.maps.event.addListener(cMarker, 'click', function() {
                cWindow.open(map, cMarker);
        });
}

function makeStudentMarker(lat, lng, title, timestamp)// same as makeMarker but for students
{
        var sCoords = new google.maps.LatLng(lat, lng);
        var sMarker;

        
        sMarker = new google.maps.Marker({
                position: sCoords,
                title: title,
        });
        sMarker.setMap(map);

        
        var sContent = '<h1>' + title + '<br></h1>' +
                        '<p><b> Lat: </b>' + lat + '<br>' +
                        '<b>Lng: </b>' + lng + '</p>';
        var sWindow = new google.maps.InfoWindow({
                content: sContent
        });
        google.maps.event.addListener(sMarker, 'click', function() {
                sWindow.close();
                sWindow.open(map, sMarker);
        });
}





</script>



</head>

<body>
	<h1> the mordor's maep </h1>
	<div id="map-canvas"></div>
	<div id="DistanceDisplay"></div>


</body>


</html>